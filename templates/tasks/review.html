{% extends "base.html" %}

{% block title %}Task Review - {{ config.get('APP_NAME', 'IT Task Manager') }}{% endblock %}

{% block page_title %}Task Review{% endblock %}

{% block page_description %}
Review and manage all tasks in the system
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
        <i class="bi bi-gear me-1"></i> Actions
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkAssignModal">
            <i class="bi bi-person-plus me-2"></i> Bulk Assign
        </a></li>
        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal">
            <i class="bi bi-pencil-square me-2"></i> Bulk Update Status
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('admin_bulk_operations') }}">
            <i class="bi bi-collection me-2"></i> More Bulk Operations
        </a></li>
    </ul>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-primary">Total Tasks</h6>
                            <h3 class="mb-0">{{ stats.total }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-list-task fs-1 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-warning">Pending</h6>
                            <h3 class="mb-0">{{ stats.pending }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-clock fs-1 text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-info">In Progress</h6>
                            <h3 class="mb-0">{{ stats.in_progress }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-arrow-right-circle fs-1 text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-danger">Overdue</h6>
                            <h3 class="mb-0">{{ stats.overdue }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('review_tasks') }}" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="all" {% if request.args.get('status') == 'all' or not request.args.get('status') %}selected{% endif %}>All Status</option>
                        <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="in_progress" {% if request.args.get('status') == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if request.args.get('status') == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if request.args.get('status') == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Priority</label>
                    <select name="priority" class="form-select">
                        <option value="all" {% if request.args.get('priority') == 'all' or not request.args.get('priority') %}selected{% endif %}>All Priority</option>
                        <option value="low" {% if request.args.get('priority') == 'low' %}selected{% endif %}>Low</option>
                        <option value="medium" {% if request.args.get('priority') == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="high" {% if request.args.get('priority') == 'high' %}selected{% endif %}>High</option>
                        <option value="critical" {% if request.args.get('priority') == 'critical' %}selected{% endif %}>Critical</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Department</label>
                    <select name="department_id" class="form-select">
                        <option value="all" {% if request.args.get('department_id') == 'all' or not request.args.get('department_id') %}selected{% endif %}>All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if request.args.get('department_id') == dept.id|string %}selected{% endif %}>{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Date From</label>
                    <input type="date" name="date_from" class="form-control" 
                           value="{{ request.args.get('date_from', '') }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Date To</label>
                    <input type="date" name="date_to" class="form-control" 
                           value="{{ request.args.get('date_to', '') }}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Tasks Table -->
    <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Task Review</h5>
            <div class="d-flex">
                <div class="form-check form-switch me-3">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                    <label class="form-check-label" for="selectAll">Select All</label>
                </div>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearSelections()">
                    <i class="bi bi-x-circle me-1"></i> Clear
                </button>
            </div>
        </div>
        
        {% if tasks.items %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" class="form-check-input" id="masterCheckbox">
                        </th>
                        <th>Task ID</th>
                        <th>Title</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Assigned To</th>
                        <th>Department</th>
                        <th>Due Date</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks.items %}
                    {% set assigned_user = users.get(task.assigned_to) %}
                    {% set task_dept = departments_dict.get(task.department_id) %}
                    <tr data-task-id="{{ task.id }}" class="{% if task.due_date and task.due_date < now and task.status != 'completed' %}table-danger{% endif %}">
                        <td>
                            <input type="checkbox" class="form-check-input task-checkbox" value="{{ task.id }}">
                        </td>
                        <td>
                            <strong>#{{ task.id }}</strong>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <a href="{{ url_for('task.task_detail', task_id=task.id) }}" class="text-decoration-none">
                                    {{ task.title|truncate(40) }}
                                </a>
                                {% if task.description %}
                                <small class="text-muted">{{ task.description|truncate(30) }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge 
                                {% if task.priority == 'critical' %}bg-danger
                                {% elif task.priority == 'high' %}bg-warning text-dark
                                {% elif task.priority == 'medium' %}bg-info
                                {% else %}bg-secondary{% endif %}">
                                {{ task.priority|title }}
                            </span>
                        </td>
                        <td>
                            <span class="badge 
                                {% if task.status == 'completed' %}bg-success
                                {% elif task.status == 'in_progress' %}bg-primary
                                {% elif task.status == 'pending' %}bg-warning text-dark
                                {% else %}bg-secondary{% endif %}">
                                {{ task.status|replace('_', ' ')|title }}
                            </span>
                        </td>
                        <td>
                            {% if assigned_user %}
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle me-2"></i>
                                <div>
                                    <div>{{ assigned_user.first_name }} {{ assigned_user.last_name }}</div>
                                    <small class="text-muted">{{ assigned_user.role }}</small>
                                </div>
                            </div>
                            {% else %}
                            <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task_dept %}
                            <span class="badge bg-light text-dark">
                                {{ task_dept.name }}
                            </span>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.due_date %}
                            <div class="d-flex flex-column">
                                <span>{{ task.due_date.strftime('%Y-%m-%d') }}</span>
                                <small class="{% if task.due_date < now and task.status != 'completed' %}text-danger{% else %}text-muted{% endif %}">
                                    {{ task.due_date.strftime('%H:%M') }}
                                    {% if task.due_date < now and task.status != 'completed' %}
                                    <i class="bi bi-exclamation-triangle ms-1"></i>
                                    {% endif %}
                                </small>
                            </div>
                            {% else %}
                            <span class="text-muted">No due date</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ task.created_at.strftime('%Y-%m-%d') }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('task.task_detail', task_id=task.id) }}" 
                                   class="btn btn-outline-info" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <span class="visually-hidden">More Actions</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('task.edit_task', task_id=task.id) }}">
                                            <i class="bi bi-pencil me-2"></i> Edit
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="reassignTask({{ task.id }})">
                                            <i class="bi bi-person-plus me-2"></i> Reassign
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" 
                                           onclick="deleteTask({{ task.id }}, '{{ task.title }}')">
                                            <i class="bi bi-trash me-2"></i> Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if tasks.pages > 1 %}
        <div class="card-footer">
            <nav aria-label="Task review pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if tasks.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('review_tasks', page=tasks.prev_num, **request.args) }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                    </li>
                    {% endif %}

                    {% for page_num in tasks.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                        {% if page_num %}
                            {% if page_num == tasks.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('review_tasks', page=page_num, **request.args) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if tasks.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('review_tasks', page=tasks.next_num, **request.args) }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="card-body text-center py-5">
            <div class="mb-4">
                <i class="bi bi-clipboard-check display-1 text-muted"></i>
            </div>
            <h4 class="text-muted">No tasks found</h4>
            <p class="text-muted mb-4">No tasks match your current filters.</p>
            <a href="{{ url_for('review_tasks') }}" class="btn btn-primary">
                <i class="bi bi-arrow-clockwise me-1"></i> Clear Filters
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Bulk Assign Modal -->
<div class="modal fade" id="bulkAssignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Bulk Assign Tasks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkAssignForm" action="{{ url_for('admin_bulk_assign') }}" method="POST">
                    <input type="hidden" name="task_ids" id="bulkTaskIds">
                    <div class="mb-3">
                        <label class="form-label">Assign to Technician</label>
                        <select name="technician_id" class="form-select" required>
                            <option value="">Select Technician</option>
                            {% for user in users.values() %}
                            {% if user.role in ['Technician', 'Supervisor', 'Admin'] %}
                            <option value="{{ user.id }}">
                                {{ user.first_name }} {{ user.last_name }} ({{ user.role }})
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </form>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Selected tasks: <span id="selectedCount">0</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="bulkAssignForm" class="btn btn-primary">Assign Selected Tasks</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Update Modal -->
<div class="modal fade" id="bulkUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Bulk Update Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkUpdateForm" action="{{ url_for('admin_bulk_status_update') }}" method="POST">
                    <input type="hidden" name="task_ids" id="bulkUpdateTaskIds">
                    <div class="mb-3">
                        <label class="form-label">Update Status To</label>
                        <select name="new_status" class="form-select" required>
                            <option value="">Select Status</option>
                            <option value="New">New</option>
                            <option value="Assigned">Assigned</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                </form>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Selected tasks: <span id="selectedCount2">0</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="bulkUpdateForm" class="btn btn-primary">Update Selected Tasks</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Checkbox selection management
    document.addEventListener('DOMContentLoaded', function() {
        const masterCheckbox = document.getElementById('masterCheckbox');
        const taskCheckboxes = document.querySelectorAll('.task-checkbox');
        
        // Master checkbox functionality
        if (masterCheckbox) {
            masterCheckbox.addEventListener('change', function() {
                taskCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
                updateSelectedCount();
            });
        }
        
        // Individual checkbox functionality
        taskCheckboxes.forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });
        
        // Update selected count function
        function updateSelectedCount() {
            const selectedTasks = Array.from(taskCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            document.getElementById('selectedCount').textContent = selectedTasks.length;
            document.getElementById('selectedCount2').textContent = selectedTasks.length;
            
            // Update hidden inputs in modals
            document.getElementById('bulkTaskIds').value = selectedTasks.join(',');
            document.getElementById('bulkUpdateTaskIds').value = selectedTasks.join(',');
            
            // Enable/disable bulk action buttons
            const bulkButtons = document.querySelectorAll('[data-bs-target="#bulkAssignModal"], [data-bs-target="#bulkUpdateModal"]');
            bulkButtons.forEach(btn => {
                if (selectedTasks.length > 0) {
                    btn.classList.remove('disabled');
                    btn.removeAttribute('disabled');
                } else {
                    btn.classList.add('disabled');
                    btn.setAttribute('disabled', 'disabled');
                }
            });
        }
        
        // Initialize count
        updateSelectedCount();
    });
    
    // Clear all selections
    function clearSelections() {
        document.querySelectorAll('.task-checkbox').forEach(cb => {
            cb.checked = false;
        });
        document.getElementById('masterCheckbox').checked = false;
        updateSelectedCount();
    }
    
    // Reassign single task
    function reassignTask(taskId) {
        // This would open a modal or redirect to reassign page
        // For now, just show an alert
        alert(`Reassign task #${taskId} - Feature coming soon!`);
    }
    
    // Delete task with confirmation
    function deleteTask(taskId, taskTitle) {
        if (confirm(`Are you sure you want to delete task "${taskTitle}"? This action cannot be undone.`)) {
            fetch(`/admin/bulk/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `task_ids=${taskId}`
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error deleting task');
                }
            })
            .catch(error => {
                alert('Error deleting task: ' + error);
            });
        }
    }
    
    // Handle bulk assign form submission
    document.getElementById('bulkAssignForm')?.addEventListener('submit', function(e) {
        const taskIds = document.getElementById('bulkTaskIds').value;
        if (!taskIds) {
            e.preventDefault();
            alert('Please select at least one task.');
            return false;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Assigning...';
        submitBtn.disabled = true;
    });
    
    // Handle bulk update form submission
    document.getElementById('bulkUpdateForm')?.addEventListener('submit', function(e) {
        const taskIds = document.getElementById('bulkUpdateTaskIds').value;
        if (!taskIds) {
            e.preventDefault();
            alert('Please select at least one task.');
            return false;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
        submitBtn.disabled = true;
    });
</script>

<style>
    .table-hover tbody tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    
    .table-danger {
        background-color: rgba(var(--bs-danger-rgb), 0.1) !important;
    }
    
    .task-checkbox {
        cursor: pointer;
    }
    
    .badge {
        font-size: 0.8em;
        padding: 0.4em 0.8em;
    }
    
    .pagination .page-item.active .page-link {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
    
    .form-check-input:checked {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
</style>
{% endblock %}