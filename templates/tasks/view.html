{% extends "base.html" %}

{% block title %}{{ task.title }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Task Details -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ task.title }}</h4>
                <div>
                    {% if task.priority == 'Critical' %}
                    <span class="badge bg-danger">{{ task.priority }}</span>
                    {% elif task.priority == 'High' %}
                    <span class="badge bg-warning">{{ task.priority }}</span>
                    {% elif task.priority == 'Medium' %}
                    <span class="badge bg-info">{{ task.priority }}</span>
                    {% else %}
                    <span class="badge bg-success">{{ task.priority }}</span>
                    {% endif %}
                    
                    {% if task.status == 'New' %}
                    <span class="badge bg-secondary">{{ task.status }}</span>
                    {% elif task.status == 'Assigned' %}
                    <span class="badge bg-primary">{{ task.status }}</span>
                    {% elif task.status == 'In Progress' %}
                    <span class="badge bg-warning">{{ task.status }}</span>
                    {% elif task.status == 'Resolved' %}
                    <span class="badge bg-success">{{ task.status }}</span>
                    {% elif task.status == 'Closed' %}
                    <span class="badge bg-dark">{{ task.status }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Task Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>Task ID:</th>
                                <td>#{{ task.id[:8] }}</td>
                            </tr>
                            <tr>
                                <th>Category:</th>
                                <td>{{ task.category }}</td>
                            </tr>
                            <tr>
                                <th>Department:</th>
                                <td>{{ task.department }}</td>
                            </tr>
                            <tr>
                                <th>Created:</th>
                                <td>{{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            <tr>
                                <th>Created By:</th>
                                <td>{{ task.created_by_user.full_name if task.created_by_user else 'Unknown' }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Assignment Details</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>Assigned To:</th>
                                <td>
                                    {% if task.assigned_to %}
                                    {{ task.assigned_user.full_name if task.assigned_user else 'Unknown' }}
                                    {% else %}
                                    <span class="text-muted">Unassigned</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Assigned By:</th>
                                <td>
                                    {% if task.assigned_by %}
                                    {{ task.assigned_by_user.full_name if task.assigned_by_user else 'Unknown' }}
                                    {% else %}
                                    <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Due Date:</th>
                                <td>
                                    {% if task.due_date %}
                                        {% if task.due_date < now and task.status in ['New', 'Assigned', 'In Progress'] %}
                                        <span class="text-danger">
                                            <i class="bi bi-exclamation-triangle"></i> {{ task.due_date.strftime('%Y-%m-%d') }}
                                        </span>
                                        {% else %}
                                        {{ task.due_date.strftime('%Y-%m-%d') }}
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">No due date</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Progress:</th>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ task.progress }}%;" 
                                                 aria-valuenow="{{ task.progress }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <span>{{ task.progress }}%</span>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <h6>Description</h6>
                <div class="card card-body bg-light mb-4">
                    {{ task.description|replace('\n', '<br>')|safe }}
                </div>
                
                {% if task.resolution_summary %}
                <h6>Resolution Summary</h6>
                <div class="card card-body bg-success bg-opacity-10">
                    {{ task.resolution_summary|replace('\n', '<br>')|safe }}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Comments</h5>
            </div>
            <div class="card-body">
                <div id="comments-container">
                    {% for comment in comments %}
                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <strong>{{ comment.user.full_name if comment.user else 'Unknown' }}</strong>
                            <small class="text-muted">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <p class="mb-1">{{ comment.content }}</p>
                        {% if comment.is_internal %}
                        <span class="badge bg-info">Internal Note</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                <form id="comment-form" class="mt-3">
                    <div class="mb-3">
                        <textarea class="form-control" id="comment-content" rows="3" 
                                  placeholder="Add a comment..."></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is-internal">
                        <label class="form-check-label" for="is-internal">
                            Internal Note (visible to IT staff only)
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Comment</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar - Actions & Activity -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                {% if task.status != 'Resolved' and task.status != 'Closed' %}
                <div class="d-grid gap-2">
                    {% if task.assigned_to == current_user.id or current_user.role in ['Admin', 'Supervisor'] %}
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#closeTaskModal">
                        <i class="bi bi-check-circle"></i> Mark as Resolved
                    </button>
                    
                    <button class="btn btn-warning" onclick="updateProgress()">
                        <i class="bi bi-arrow-up-right"></i> Update Progress
                    </button>
                    {% endif %}
                    
                    {% if current_user.role in ['Admin', 'Supervisor'] %}
                    <button class="btn btn-info" onclick="assignToMe()">
                        <i class="bi bi-person-plus"></i> Assign to Me
                    </button>
                    
                    <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#reassignModal">
                        <i class="bi bi-people"></i> Reassign Task
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> This task has been resolved.
                    <br>
                    <small>Closed by: {{ task.closed_by_user.full_name if task.closed_by_user else 'Unknown' }}</small>
                    <br>
                    <small>Closed at: {{ task.closed_at.strftime('%Y-%m-%d %H:%M') if task.closed_at else 'Unknown' }}</small>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <a href="{{ url_for('task.task_list') }}" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-left"></i> Back to Tasks
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Activity Log -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Activity Log</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for activity in activities %}
                    <div class="mb-3">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="bi bi-circle-fill text-primary"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <small class="text-muted">{{ activity.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                <p class="mb-1 small">{{ activity.description }}</p>
                                {% if activity.old_value %}
                                <small class="text-muted">Changed: {{ activity.old_value }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Close Task Modal -->
<div class="modal fade" id="closeTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Close Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Resolution Summary *</label>
                    <textarea class="form-control" id="resolution-summary" rows="4" required></textarea>
                    <small class="text-muted">Describe how the task was resolved</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="closeTask()">Close Task</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function closeTask() {
    const summary = document.getElementById('resolution-summary').value;
    if (!summary) {
        alert('Please enter a resolution summary');
        return;
    }
    
    fetch("{{ url_for('task.close_task', task_id=task.id) }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            resolution_summary: summary
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function updateProgress() {
    const progress = prompt('Enter new progress percentage (0-100):', '{{ task.progress }}');
    if (progress !== null) {
        fetch("{{ url_for('task.update', task_id=task.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                progress: parseInt(progress)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function assignToMe() {
    fetch("{{ url_for('task.update', task_id=task.id) }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            assigned_to: '{{ current_user.id }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Comment form submission
document.getElementById('comment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const content = document.getElementById('comment-content').value;
    const isInternal = document.getElementById('is-internal').checked;
    
    if (!content) {
        alert('Please enter a comment');
        return;
    }
    
    fetch("{{ url_for('task.add_comment', task_id=task.id) }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content,
            is_internal: isInternal
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
});
</script>
{% endblock %}