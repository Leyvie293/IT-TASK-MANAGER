<!-- templates/tasks/detail.html -->
{% extends "base.html" %}

{% block title %}{{ task.title }} - {{ app_name }}{% endblock %}

{% block page_title %}{{ task.title }}{% endblock %}

{% block page_description %}
    <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="badge 
            {% if task.status == 'New' %}bg-primary
            {% elif task.status == 'Assigned' %}bg-info
            {% elif task.status == 'In Progress' %}bg-warning
            {% elif task.status == 'Resolved' %}bg-success
            {% elif task.status == 'Closed' %}bg-secondary
            {% else %}bg-dark{% endif %}">
            {{ task.status }}
        </span>
        <span class="badge 
            {% if task.priority == 'Low' %}bg-success
            {% elif task.priority == 'Medium' %}bg-primary
            {% elif task.priority == 'High' %}bg-warning
            {% elif task.priority == 'Critical' %}bg-danger
            {% else %}bg-secondary{% endif %}">
            {{ task.priority }}
        </span>
        {% if task.department %}
        <span class="badge bg-info">{{ task.department }}</span>
        {% endif %}
        {% if task.is_overdue %}
        <span class="badge bg-danger">Overdue</span>
        {% endif %}
    </div>
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{{ safe_url_for('task.task_list') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back to Tasks
    </a>
    {% if can_edit %}
    <a href="{{ safe_url_for('task.edit', task_id=task.id) }}" class="btn btn-primary">
        <i class="bi bi-pencil me-1"></i> Edit
    </a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Task Details Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-card-text me-2"></i>Description
                    </h5>
                    <div class="task-description">
                        {% if task.description %}
                            {{ task.description|nl2br|safe }}
                        {% else %}
                            <p class="text-muted fst-italic">No description provided.</p>
                        {% endif %}
                    </div>
                    
                    {% if task.notes %}
                    <hr>
                    <h6 class="card-title mb-3">
                        <i class="bi bi-chat-text me-2"></i>Additional Notes
                    </h6>
                    <div class="task-notes">
                        {{ task.notes|nl2br|safe }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Activity Timeline -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-clock-history me-2"></i>Activity Timeline
                    </h5>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Task Created</h6>
                                <p class="text-muted small mb-0">
                                    {{ task.created_at|format_datetime }}
                                    {% if task.created_user %}
                                    by {{ task.created_user.full_name if task.created_user.full_name else task.created_user.first_name ~ ' ' ~ task.created_user.last_name }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        
                        {% if task.assigned_at %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Task Assigned</h6>
                                <p class="text-muted small mb-0">
                                    {{ task.assigned_at|format_datetime }}
                                    {% if task.assigned_user %}
                                    to {{ task.assigned_user.full_name if task.assigned_user.full_name else task.assigned_user.first_name ~ ' ' ~ task.assigned_user.last_name }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if task.started_at %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Work Started</h6>
                                <p class="text-muted small mb-0">
                                    {{ task.started_at|format_datetime }}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if task.completed_at %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Task Completed</h6>
                                <p class="text-muted small mb-0">
                                    {{ task.completed_at|format_datetime }}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if task.updated_at and task.updated_at != task.created_at %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-secondary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Last Updated</h6>
                                <p class="text-muted small mb-0">
                                    {{ task.updated_at|format_datetime }}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Task Info Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-info-circle me-2"></i>Task Information
                    </h5>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Assigned To</small>
                        {% if task.assigned_user %}
                        <div class="d-flex align-items-center mt-1">
                            <div class="me-2">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <div>
                                <strong>{{ task.assigned_user.full_name if task.assigned_user.full_name else task.assigned_user.first_name ~ ' ' ~ task.assigned_user.last_name }}</strong>
                                <div class="small text-muted">
                                    {{ task.assigned_user.role }}
                                    {% if task.assigned_user.department %}
                                    • {{ task.assigned_user.department }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <span class="badge bg-secondary">Unassigned</span>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Created By</small>
                        {% if task.created_user %}
                        <div class="d-flex align-items-center mt-1">
                            <div class="me-2">
                                <i class="bi bi-person-plus"></i>
                            </div>
                            <div>
                                <strong>{{ task.created_user.full_name if task.created_user.full_name else task.created_user.first_name ~ ' ' ~ task.created_user.last_name }}</strong>
                                <div class="small text-muted">
                                    {{ task.created_user.role }}
                                    {% if task.created_user.department %}
                                    • {{ task.created_user.department }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <span class="text-muted">System</span>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Due Date</small>
                        <div class="d-flex align-items-center mt-1">
                            <div class="me-2">
                                <i class="bi bi-calendar-event"></i>
                            </div>
                            <div>
                                {% if task.due_date %}
                                    <strong>{{ task.due_date|format_date }}</strong>
                                    {% if task.is_overdue %}
                                    <span class="badge bg-danger ms-2">Overdue</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted fst-italic">No due date</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Progress</small>
                        <div class="mt-1">
                            <div class="d-flex justify-content-between mb-1">
                                <span>{{ task.progress or 0 }}%</span>
                                <span>{{ task.status }}</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar 
                                    {% if task.progress == 100 %}bg-success
                                    {% elif task.progress >= 50 %}bg-primary
                                    {% else %}bg-warning{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ task.progress or 0 }}%">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Task ID</small>
                        <code class="small">{{ task.task_id or task.id }}</code>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Created</small>
                        <span>{{ task.created_at|format_datetime }}</span>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Last Updated</small>
                        <span>{{ task.updated_at|format_datetime if task.updated_at else task.created_at|format_datetime }}</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            {% if can_edit %}
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-lightning me-2"></i>Quick Actions
                    </h5>
                    
                    <div class="d-grid gap-2">
                        {% if task.status != 'In Progress' and task.status != 'Resolved' and task.status != 'Closed' %}
                        <button type="button" class="btn btn-warning" 
                                onclick="updateTaskStatus('In Progress')">
                            <i class="bi bi-play-circle me-1"></i> Start Work
                        </button>
                        {% endif %}
                        
                        {% if task.status == 'In Progress' %}
                        <button type="button" class="btn btn-success" 
                                onclick="updateTaskStatus('Resolved')">
                            <i class="bi bi-check-circle me-1"></i> Mark as Resolved
                        </button>
                        {% endif %}
                        
                        {% if task.status == 'Resolved' and current_user.role in ['Admin', 'Supervisor'] %}
                        <button type="button" class="btn btn-secondary" 
                                onclick="updateTaskStatus('Closed')">
                            <i class="bi bi-archive me-1"></i> Close Task
                        </button>
                        {% endif %}
                        
                        {% if task.status == 'New' and current_user.role in ['Admin', 'Supervisor'] and not task.assigned_to %}
                        <button type="button" class="btn btn-info" 
                                onclick="assignToSelf()">
                            <i class="bi bi-person-plus me-1"></i> Assign to Me
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Update Task Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="statusUpdateForm" method="POST" action="{{ safe_url_for('task.update_status', task_id=task.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="status" class="form-label">New Status</label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="">Select Status</option>
                            <option value="New">New</option>
                            <option value="Assigned">Assigned</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Add any notes about this status change..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="progress" class="form-label">Progress (%)</label>
                        <input type="range" class="form-range" id="progress" name="progress" 
                               min="0" max="100" step="10" value="{{ task.progress or 0 }}">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small id="progressValue">{{ task.progress or 0 }}%</small>
                            <small>100%</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Progress slider update
        const progressSlider = document.getElementById('progress');
        const progressValue = document.getElementById('progressValue');
        
        if (progressSlider && progressValue) {
            progressSlider.addEventListener('input', function() {
                progressValue.textContent = this.value + '%';
            });
        }
        
        // Copy Task ID to clipboard
        const taskIdElement = document.querySelector('code');
        if (taskIdElement) {
            taskIdElement.style.cursor = 'pointer';
            taskIdElement.title = 'Click to copy Task ID';
            taskIdElement.addEventListener('click', function() {
                const text = this.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = this.textContent;
                    this.textContent = 'Copied!';
                    setTimeout(() => {
                        this.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            });
        }
    });
    
    // Status update functions
    function updateTaskStatus(newStatus) {
        const statusSelect = document.getElementById('status');
        if (statusSelect) {
            statusSelect.value = newStatus;
            
            // Auto-set progress based on status
            const progressSlider = document.getElementById('progress');
            if (progressSlider) {
                if (newStatus === 'In Progress') {
                    progressSlider.value = '50';
                    document.getElementById('progressValue').textContent = '50%';
                } else if (newStatus === 'Resolved') {
                    progressSlider.value = '100';
                    document.getElementById('progressValue').textContent = '100%';
                }
            }
            
            const modal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
            modal.show();
        }
    }
    
    function assignToSelf() {
        if (confirm('Assign this task to yourself?')) {
            fetch("{{ safe_url_for('task.assign_to_self', task_id=task.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to assign task: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while assigning the task.');
            });
        }
    }
    
    // Form submission handling
    const statusUpdateForm = document.getElementById('statusUpdateForm');
    if (statusUpdateForm) {
        statusUpdateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
            }
            
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to update status: ' + data.message);
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Update Status';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the status.');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Update Status';
                }
            });
        });
    }
</script>

<style>
    .task-description, .task-notes {
        line-height: 1.6;
        white-space: pre-line;
    }
    
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline:before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #495057;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -30px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid #212529;
    }
    
    .timeline-content {
        padding-left: 10px;
    }
    
    code {
        background-color: rgba(108, 117, 125, 0.3);
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875em;
    }
    
    code:hover {
        background-color: rgba(108, 117, 125, 0.5);
    }
    
    .progress {
        background-color: #495057;
    }
    
    .progress-bar {
        transition: width 0.3s ease;
    }
</style>
{% endblock %}